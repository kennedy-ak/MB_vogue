{% extends 'base.html' %}

{% block title %}{{ product.name }} - MB Vogue{% endblock %}

{% block extra_css %}
<style>
    .thumbnail-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        cursor: pointer;
        border: 2px solid transparent;
    }
    .thumbnail-img:hover, .thumbnail-img.active {
        border-color: #0d6efd;
    }
    .main-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'core:product_list' %}">Shop</a></li>
            <li class="breadcrumb-item"><a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a></li>
            <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Product Images -->
        <div class="col-md-6 mb-4">
            <div class="mb-3">
                {% if images %}
                <img src="{{ images.0.image.url }}" alt="{{ product.name }}" class="main-image rounded" id="mainImage">
                {% else %}
                <div class="main-image bg-secondary d-flex align-items-center justify-content-center rounded">
                    <i class="bi bi-image" style="font-size: 100px;"></i>
                </div>
                {% endif %}
            </div>
            {% if images.count > 1 %}
            <div class="d-flex gap-2">
                {% for image in images %}
                <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" class="thumbnail-img rounded {% if forloop.first %}active{% endif %}" onclick="changeImage(this)">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <h1 class="mb-3">{{ product.name }}</h1>
            <p class="lead text-primary mb-3">GHâ‚µ{{ product.price }}</p>
            <p class="text-muted mb-4">{{ product.description }}</p>

            {% if variants %}
            <form id="addToCartForm" method="post" action="{% url 'core:cart_add' %}">
                {% csrf_token %}
                <input type="hidden" name="variant_id" id="variantId" value="{% if first_variant %}{{ first_variant.id }}{% endif %}">

                <!-- Color Selection -->
                <div class="mb-3">
                    <label class="form-label">Color:</label>
                    <select name="color" id="colorSelect" class="form-select" onchange="updateVariant()">
                        {% for color in colors %}
                        <option value="{{ color }}" {% if color == first_color %}selected{% endif %}>{{ color|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Size Selection -->
                <div class="mb-3">
                    <label class="form-label">Size:</label>
                    <select name="size" id="sizeSelect" class="form-select" onchange="updateVariant()">
                        {% for size in available_sizes %}
                        <option value="{{ size }}">{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Quantity -->
                <div class="mb-4">
                    <label class="form-label">Quantity:</label>
                    <input type="number" name="quantity" value="1" min="1" max="99" class="form-control" style="width: 100px;">
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">
                    <i class="bi bi-cart-plus"></i> Add to Cart
                </button>
            </form>
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> This product is currently out of stock.
            </div>
            {% endif %}

            {% if user.is_authenticated %}
            <div class="mt-3">
                <a href="{% url 'core:wishlist_add' product.id %}" class="btn btn-outline-primary">
                    <i class="bi bi-heart"></i> Add to Wishlist
                </a>
            </div>
            {% endif %}

            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="card-title">Product Details</h6>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Category:</strong> {{ product.category.name }}</li>
                        <li><strong>Availability:</strong> {% if product.available %}In Stock{% else %}Out of Stock{% endif %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variant data structure - maps color -> size -> variant ID
const variantsData = {
    {% for variant in variants %}
    '{{ variant.color }}': {
        '{{ variant.size }}': {{ variant.id }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

function changeImage(thumbnail) {
    document.getElementById('mainImage').src = thumbnail.src;
    document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
    thumbnail.classList.add('active');
}

function updateVariant() {
    const colorSelect = document.getElementById('colorSelect');
    const sizeSelect = document.getElementById('sizeSelect');
    const variantIdInput = document.getElementById('variantId');

    const selectedColor = colorSelect.value;
    const selectedSize = sizeSelect.value;

    // Update variant ID based on selection
    if (variantsData[selectedColor] && variantsData[selectedColor][selectedSize]) {
        variantIdInput.value = variantsData[selectedColor][selectedSize];
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateVariant();
});
</script>
{% endblock %}
